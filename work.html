This is ptokmak's chnages.